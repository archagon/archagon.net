<!DOCTYPE html>
<html lang="en-US">

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>That Magical Model Window — Archagon Was Here</title>
<meta name="description" content="Alexei's pile o'stuff, featuring writing on software development, travel, photography, and more.
">

<!-- opengraph content metadata -->
<meta property="og:title" content="That Magical Model Window">
<meta property="og:site_name" content="Archagon Was Here">
<meta property="og:type" content="article"> <!-- TODO: other types? -->
<meta property="og:url" content="http://archagon.net/blog/2014/06/21/that-magical-model-window/">

<!-- twitter content metadata -->
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@archagon" />
<meta name="twitter:title" content="That Magical Model Window" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic,900">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:300,400,500,600,700&amp;subset=latin-ext">

<!-- <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Merriweather:300,300i,400,400i,700,700i&amp;subset=cyrillic,cyrillic-ext"> -->
<!-- <link href="//fonts.googleapis.com/css?family=Vollkorn:400,400i,600,600i,700,700i&amp;subset=cyrillic,cyrillic-ext,latin-ext" rel="stylesheet"> -->
<!-- <link href="https://fonts.googleapis.com/css?family=Muli:700,800,900" rel="stylesheet"> -->
<!-- <link href="https://fonts.googleapis.com/css?family=Cabin:400,500,600,700" rel="stylesheet"> -->

<link rel="stylesheet" href="/css/normalize.css">
<link rel="stylesheet" href="/css/main.css">

<link rel="canonical" href="http://archagon.net/blog/2014/06/21/that-magical-model-window/">
<link rel="icon" href="/images/favicon/favicon-96x96.png">

<!-- inline category colors -->
<style>
.category-default.category-swatch {
  background-color: #a1a18c; }
.category-default.document-header-category {
  background-color: #8a8a70; }
.category-default.post-title {
  background-color: #a1a18c;
  text-shadow: 0px 2px #8a8a70; }

.category-jekyll.category-swatch {
  background-color: #9e6948; }
.category-jekyll.document-header-category {
  background-color: #7b5138; }
.category-jekyll.post-title {
  background-color: #9e6948;
  text-shadow: 0px 2px #7b5138; }

.category-travel.category-swatch {
  background-color: #957dc3; }
.category-travel.document-header-category {
  background-color: #795bb2; }
.category-travel.post-title {
  background-color: #957dc3;
  text-shadow: 0px 2px #795bb2; }

.category-programming.category-swatch {
  background-color: #f87495; }
.category-programming.document-header-category {
  background-color: #f64370; }
.category-programming.post-title {
  background-color: #f87495;
  text-shadow: 0px 2px #f64370; }

.category-technology.category-swatch {
  background-color: #fb9635; }
.category-technology.document-header-category {
  background-color: #f87c05; }
.category-technology.post-title {
  background-color: #fb9635;
  text-shadow: 0px 2px #f87c05; }

.category-design.category-swatch {
  background-color: #6ebab3; }
.category-design.document-header-category {
  background-color: #4fa69e; }
.category-design.post-title {
  background-color: #6ebab3;
  text-shadow: 0px 2px #4fa69e; }

.category-releases.category-swatch {
  background-color: #5cacfc; }
.category-releases.document-header-category {
  background-color: #2993fc; }
.category-releases.post-title {
  background-color: #5cacfc;
  text-shadow: 0px 2px #2993fc; }

.category-reviews.category-swatch {
  background-color: #38c04f; }
.category-reviews.document-header-category {
  background-color: #2c993f; }
.category-reviews.post-title {
  background-color: #38c04f;
  text-shadow: 0px 2px #2c993f; }

.category-personal.category-swatch {
  background-color: #899fbc; }
.category-personal.document-header-category {
  background-color: #6885aa; }
.category-personal.post-title {
  background-color: #899fbc;
  text-shadow: 0px 2px #6885aa; }

</style>

<!-- footnotes -->
<link rel="stylesheet" href="/js/bigfoot-number.css">
<!-- <link rel="stylesheet" href="/js/bigfoot-default.css"> -->
<script type="text/javascript" src="/js/jquery.min.js" defer></script>
<script type="text/javascript" src="/js/bigfoot.min.js" defer></script>
<script type="text/javascript">
    // defer does not work for inline scripts
    window.addEventListener('DOMContentLoaded', function() {
        $.bigfoot({
            actionOriginalFN: "ignore",
            //// TODO: style like this: https://marco.org/2018/03/13/overcast41
            // numberResetSelector: "article",
            // buttonMarkup: (
            //     "<a href=\"#\" class=\"footnote-button\" " +
            //         "id=\"\" " +
            //         "data-footnote-identifier=\"\" " +
            //         "data-footnote-style=\"default\"" +
            //         "alt=\"See Footnote \" " +
            //         "rel=\"footnote\"" +
            //         "data-footnote-content=\"\">" +
            //             "" +
            //     "</a>"
            // )
        });
    });
</script>
<style>
.bigfoot-footnote__button:after
{
    color: #777;
}
.bigfoot-footnote__button
{
    width: 1.2em;
    height: 0.8em;
    /*padding: 0.5em;*/
    border-radius: 0.3em;
    font-size: 1.1em;
}
.bigfoot-footnote p
{
    font-size: 0.9em;
    /*text-align: left;
    -webkit-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;*/
}
</style>
</head>

<body class="body-background">

<header class="site-header">
    <!-- full-width background container -->
    <div class="site-header-title-background">
        <!-- centered padded section -->
        <div class="site-header-title-container wrapper">
            <div class="site-title">
                <a href="/"><img src="/images/avatar2.jpg" class="site-title-icon"></a>
                <a href="/"><img src="/images/graphics/title.svg" class="site-title-title"></a>
            </div>
        </div>
    </div>
    <!-- full-width background container -->
    <div class="site-header-nav-background header-footer-background">
        <!-- centered padded section -->
        <div class="site-nav-container wrapper">
            <nav class="site-nav">
                <ul>
                    <li><a class="site-nav-page-link" href="/">Blog</a></li>
                    <!-- <li><a class="site-nav-page-link" href="/timeline/">Travel</a></li> -->
                    <li><a class="site-nav-page-link" href="/archive/">Archive</a></li>
                    <!-- <li><a class="site-nav-page-link" href="/projects/">Projects</a></li> -->
                    <li><a class="site-nav-page-link" href="/about/">About</a></li>
                    <li><span class="site-nav-page-link site-nav-page-link-icons"><a href="/feed.xml"><img src="/images/feed-icon.png" class="header-footer-icon"></a>/<a href="https://twitter.com/archagon"><img src="/images/twitter-icon.png" class="header-footer-icon"></a></span></li>
                </ul>
            </nav>
        </div>
    </div>
</header>

<div class="page-content">

<div class="document-post category-programming" id="sel_blog20140621that-magical-model-window">
<div class="wrapper">

<header class="section-header">
    <h1 class="post-title">That Magical Model Window</h1>
    <h2 class="post-meta">Jun 21, 2014<span class="document-header-categories"> <span class="document-header-category category-programming">programming</span></span></h2>
</header>

<article class="section-content">

<p>I recently ran into the following issue in my Objective-C code. Let’s say you have a model class<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup> that has (among other things) an <code class="highlighter-rouge">NSMutableArray</code> of other model classes. How do you let outside objects modify this collection? One obvious solution is to add your own custom accessors: <code class="highlighter-rouge">addObject:</code>, <code class="highlighter-rouge">removeObject:</code>, and so forth. But that’s a little sad, since it’s essentially a simplified, non-standard duplicate of the <code class="highlighter-rouge">NSMutableArray</code> interface. The other obvious choice is to expose the array directly. But oh boy! If you do any pre- or post-processing on add or delete, there’s a world of pain waiting for you. It’s just not wise to let users mess around with the internals of your model like that. Maybe if <code class="highlighter-rouge">NSMutableArray</code> had a delegate, we could expose the array and then let the model object (as the delegate) have the final say on any changes, but sadly, to my knowledge, it does not. (<code class="highlighter-rouge">NSArrayController</code> on OSX and <code class="highlighter-rouge">CFArray</code> might have that functionality, but that’s just too much work for too little gain.) Finally, there’s the issue of key-value observation. How do we observe changes to the array? If we simply observe the array property, we’ll only get notifications when it’s set. Do we observe the array’s <code class="highlighter-rouge">count</code> property? (Doesn’t work, and wouldn’t handle replacement even if it did.) Do we add manual KVO calls to our custom accessors? Do we set a property somewhere whenever the array is modified?</p>

<p>It turns out there’s a solution to all these problems, and it involves something called key-value coding of collections.</p>

<!--more-->

<p>Let’s backtrack a bit. You might know that when you declare (and optionally synthesize) a property, you automatically get a “key” to access that property — basically, the name of the property as a string. This means that any outside class can access and observe your property by using key path notation. (If <code class="highlighter-rouge">object1</code> contains <code class="highlighter-rouge">object2</code>, and <code class="highlighter-rouge">object2</code> contains <code class="highlighter-rouge">myProperty</code>, you can access <code class="highlighter-rouge">myProperty</code> from <code class="highlighter-rouge">object1</code> by using the  “object2.myProperty” key path in a <code class="highlighter-rouge">valueForKeyPath:</code> call on <code class="highlighter-rouge">object1</code>.) As it turns out, this automatic property coding is not the only type of key-value coding available. There are also special kinds of key-value coding for ordered and unordered collections, and these do <em>not</em> get generated automatically, even for properties that are arrays or sets. (This is what Apple means when they talk about “to-many relationships” in their KVC documentation. When discussing model objects, a “to-many relationship” is simply an array or set property that contains other model objects. It seems that Apple prefers to think of the model object graph as a series of relationships instead of objects with array or set properties, which explains the slightly odd terminology.)</p>

<p>KVC is based heavily on naming conventions. You enable KVC for an array or set property by simply adding a small set of methods in the containing class with the corresponding property name in the selector. For example, if you have an <code class="highlighter-rouge">NSMutableArray</code> called <code class="highlighter-rouge">names</code> in your model object, all you have to do is (at minimum) implement the following methods<sup id="fnref:2"><a href="#fn:2" class="footnote">2</a></sup> in the class containing the array:</p>

<ul>
  <li><code class="highlighter-rouge">countOfNames</code></li>
  <li><code class="highlighter-rouge">objectInNamesAtIndex:</code></li>
  <li><code class="highlighter-rouge">insertObject:inNamesAtIndex:</code></li>
  <li><code class="highlighter-rouge">removeObjectFromNamesAtIndex:</code></li>
</ul>

<p>…and voilà! Not only can you now access the array members using key path notation, but you also get KVO of insertions, removals, and replacements (along with the affected indices) for free. The <code class="highlighter-rouge">NSMutableArray</code> interface already contains all these methods, so you can simply forward the calls to <code class="highlighter-rouge">names</code>, along with any pre- or post-processing as needed. Now you can declare these methods as the public interface to your array and feel good that you’re using a documented standard. (You can read about a few optional methods you can implement, as well as the corresponding methods for sets, in Apple’s <a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/KeyValueCoding/Articles/KeyValueCoding.html">“Key-Value Coding Programming Guide”</a>.)</p>

<p>But here’s the best part. Once you’ve implemented these passthrough methods, you get access to <code class="highlighter-rouge">mutableArrayValueForKey:</code>. This method returns an object that looks and acts like an <code class="highlighter-rouge">NSMutableArray</code>, but instead of modifying your array directly, it proxies all its calls through the KVC methods you implemented earlier. This means that you can <em>safely</em> present this faux-<code class="highlighter-rouge">NSMutableArray</code> as the interface to your collection, allowing users to exploit the full power of <code class="highlighter-rouge">NSMutableArray</code>‘s interface while still maintaining direct control over how the data gets added and removed!</p>

<p>Here’s a sample implementation that I particularly like. (Pardon the lack of ARC-ness, I’m still getting on that train.) Public header:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// MyModelClass.h

@interface MyModelClass : NSObject

@property (nonatomic, readonly, getter=namesProxy) NSMutableArray* names;

// optional declarations to make your public interface explicit
-(NSUInteger) countOfNames;
-(NSString*) objectInNamesAtIndex:(NSUInteger)index;
-(void) insertObject:(NSString*)object inNamesAtIndex:(NSUInteger)index;
-(void) removeObjectFromNamesAtIndex:(NSUInteger)index;

@end
</code></pre></div></div>

<p>Private header<sup id="fnref:3"><a href="#fn:3" class="footnote">3</a></sup>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// MyModelClass_.h

#import "MyModelClass.h"

@interface MyModelClass ()

@property (nonatomic, retain) NSMutableArray* namesMutable;

@end
</code></pre></div></div>

<p>Implementation:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// MyModelClass.m

#import "MyModelClass_.h"

@implementation MyModelClass

@dynamic names;

-(id) init
{
    self = [super init];
    if (self)
    {
        self.namesMutable = [NSMutableArray array];
    }
    return self;
}

-(NSMutableArray*) namesProxy
{
    return [self mutableArrayValueForKey:@"names"];
}

-(NSUInteger) countOfNames
{
    return [self.namesMutable count];
}

-(NSString*) objectInNamesAtIndex:(NSUInteger)index
{
    return [self.namesMutable objectAtIndex:index];
}

-(void) insertObject:(NSString*)object inNamesAtIndex:(NSUInteger)index
{
    return [self.namesMutable insertObject:object atIndex:index];
}

-(void) removeObjectFromNamesAtIndex:(NSUInteger)index
{
    return [self.namesMutable removeObjectAtIndex:index];
}

@end
</code></pre></div></div>

<p>With this design, you can observe <code class="highlighter-rouge">names</code> and get notifications whenever the <code class="highlighter-rouge">namesMutable</code> array is modified, <em>even though there’s no actual property named <code class="highlighter-rouge">names</code>!</em> You can also retrieve the <code class="highlighter-rouge">names</code> property directly from the object (which creates the proxy array) and modify it to your liking. (The getter is called <code class="highlighter-rouge">namesProxy</code> to avoid confusing the <code class="highlighter-rouge">mutableArrayValueForKey:</code> call.) Nobody without the private header has access to the internal <code class="highlighter-rouge">namesMutable</code> array; everything is instead handled either through the standard KVC collection methods or through the proxy array.</p>

<p>With this pattern, we can have it all: a standard interface to mutate our model’s collections while still giving the model final authority, the ability to leverage the full power of <code class="highlighter-rouge">NSArray</code> and <code class="highlighter-rouge">NSSet</code> for these mutations without having to write a ton of custom code, and the ability to key-value observe collections in detail. Pretty useful!<sup id="fnref:4"><a href="#fn:4" class="footnote">4</a></sup></p>

<p>For a detailed look at KVO and KVC, <a href="http://www.objc.io/issue-7/key-value-coding-and-observing.html">read this excellent article on objc.io</a>. They cover a similar pattern in the last section of the article, but my implementation is superior <a href="https://github.com/objcio/issue-7-contact-editor/blob/master/Contact%20Editor/ContactList.mm#L51">to their sample code</a> in that it allows you to both access <code class="highlighter-rouge">names</code> directly <em>and</em> observe it. Their “Primes” example also does not work.</p>

<p><strong>Post-script.</strong> In my case, I had one additional complication: my array had to always be sorted. This left me with a bit of a dilemma. If I sorted the proxy array right in the <code class="highlighter-rouge">insertObject:in&lt;Key&gt;AtIndex:</code>, my receivers would get two KVO calls: one for the initial insert, and one for the re-insert from the sort. This meant that if my observers always expected my data to be sorted, the first call would give them bad data. On the other hand, if I sorted my real array instead of the proxy array, there would be no KVO notifications for the changes from the sort, and so the index passed to my observers would be wrong. I tried implementing the interface as an unordered collection (while leaving my data as an array) and everything worked correctly, but the interface mismatch irked me. Finally, I found the one true solution: if you implement the class method <code class="highlighter-rouge">automaticallyNotifiesObserversOf&lt;Key&gt;</code> and return a big fat <code class="highlighter-rouge">NO</code>, you can implement your own notifications for all the passthrough calls, meaning that you can sort on insert and only send a single notification. This required a bit more boilerplate code, but it was a small price to pay for a perfect implementation!</p>

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>As in MVC model. <a href="#fnref:1" class="reversefootnote">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:2">
      <p>Incidentally, these KVC passthrough methods are almost identical to the methods you need to override if you’re subclassing <code class="highlighter-rouge">NSArray</code> or <code class="highlighter-rouge">NSSet</code>. The whole process feels oddly like multiple inheritance. <a href="#fnref:2" class="reversefootnote">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:3">
      <p>In case you’re confused, you can create multiple header files using class extensions (otherwise known as anonymous categories) to simplify your public interface. Read more about ‘em in Apple’s <a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/ProgrammingWithObjectiveC/CustomizingExistingClasses/CustomizingExistingClasses.html">“Customizing Existing Classes”</a> documentation. <a href="#fnref:3" class="reversefootnote">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:4">
      <p>With key-value coding of collections, you can do a few more interesting things with key paths. Check out the <a href="http://nshipster.com/kvc-collection-operators/">NSHipster article on KVC collection operators</a> for a brief overview. <a href="#fnref:4" class="reversefootnote">&#8617;&#xfe0e;</a></p>
    </li>
  </ol>
</div>
<div class="signature">
    <p>—<span class="signature-name">Archagon</span></p>
    <p class="signature-date">June 21, 2014</p>
</div>

</article>

</div>
</div>

</div>

<footer class="site-footer">
    <!-- full-width background container -->
    <div class="site-footer-background header-footer-background">
        <!-- centered padded section -->
        <div class="site-footer-container wrapper">
            <div class="site-footer-credits">
                <p>Copyright &copy; 2018 Alexei Baboulevitch. ("It's copylicious!")</p>
            </div>
            <div class="site-footer-links"> <!-- not really a list, so I don't feel bad about using div -->
                <a href="/feed.xml"><img src="/images/feed-icon.png" class="header-footer-icon"> <span>Subscribe via RSS</span></a>
                <a href="https://twitter.com/archagon"><img src="/images/twitter-icon.png" class="header-footer-icon"> <span>Tweet me up</span></a>
            </div>
        </div>
    </div>
</footer>

<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-44612590-2', 'auto');
    ga('send', 'pageview');
</script>

</body>

</html>